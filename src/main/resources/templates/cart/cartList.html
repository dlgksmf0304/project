<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .qty-input { text-align: center; width: 60px; }
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="container py-4">

<h2 class="mb-4">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>

<table class="table table-bordered align-middle text-center">
    <thead class="table-light">
    <tr>
        <th>ìƒí’ˆëª…</th>
        <th>ìˆ˜ëŸ‰</th>
        <th>ê°€ê²©</th>
        <th>í•©ê³„</th>
        <th>ì‘ì—…</th>
    </tr>
    </thead>
    <tbody id="cart-body">
    <!-- DBì—ì„œ ê°€ì ¸ì˜¨ ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆë“¤ -->
    <tr th:each="item : ${cartItems}" th:attr="data-id=${item.cartItemId}" th:data-price="${item.price}">
        <td th:text="${item.itemNm}">ìƒí’ˆëª…</td>
        <td>
            <input type="number" min="1" class="form-control form-control-sm qty-input"
                   th:value="${item.count != null ? item.count : 1}" />
        </td>
        <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')}">0</td>
        <td th:text="${#numbers.formatInteger(item.price * (item.count != null ? item.count : 1), 0, 'COMMA')}" class="item-total">0</td>
        <td>
            <!-- ìˆ˜ì •: ê°œë³„ ì‚­ì œ ë²„íŠ¼ AJAX -->
            <button class="btn btn-danger btn-sm btn-delete">ì‚­ì œ</button>
        </td>
    </tr>

    <!-- ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆì„ ë•Œ í‘œì‹œ -->
    <tr th:if="${#lists.isEmpty(cartItems)}" id="empty-cart-row">
        <td colspan="5" class="text-muted py-4">
            <div class="text-center">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<!-- ìš”ì•½ ì •ë³´ ë°•ìŠ¤ -->
<div class="summary-box mt-4">
    <div class="row">
        <div class="col-md-6">
            <h6 class="mb-2">ğŸ“¦ ì´ ìƒí’ˆ ìˆ˜ëŸ‰: <span id="total-quantity" class="text-primary fw-bold">0</span> ê°œ</h6>
        </div>
        <div class="col-md-6 text-end">
            <h5 class="mb-0">ğŸ’° ì´ ê²°ì œ ê¸ˆì•¡: <span id="cart-total" class="text-success fw-bold">0</span> ì›</h5>
        </div>
    </div>
</div>

<div class="text-end mt-3">
    <button id="btn-clear" class="btn btn-warning me-2">ì „ì²´ ë¹„ìš°ê¸°</button>
    <button id="btn-order" class="btn btn-primary">ì£¼ë¬¸í•˜ê¸°</button>
</div>

<script>
    // ì „ì²´ ì¥ë°”êµ¬ë‹ˆ ì´ì•¡ê³¼ ì´ ìˆ˜ëŸ‰ ê³„ì‚° í•¨ìˆ˜
    function calculateCartSummary() {
        let totalAmount = 0;
        let totalQuantity = 0;

        $("#cart-body tr:not(#empty-cart-row)").each(function(){
            let price = parseInt($(this).data("price")) || 0;
            let qty = parseInt($(this).find(".qty-input").val()) || 0;

            totalAmount += price * qty;
            totalQuantity += qty;
        });

        $("#cart-total").text(totalAmount.toLocaleString());
        $("#total-quantity").text(totalQuantity);

        if ($("#cart-body tr:not(#empty-cart-row)").length === 0) {
            $("#cart-total").text("0");
            $("#total-quantity").text("0");
            showEmptyCartMessage();
        }
    }

    function showEmptyCartMessage() {
        if ($("#empty-cart-row").length === 0) {
            $("#cart-body").append(`
                <tr id="empty-cart-row">
                    <td colspan="5" class="text-muted py-4">
                        <div class="text-center">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </td>
                </tr>
            `);
        }
    }

    function hideEmptyCartMessage() {
        $("#empty-cart-row").remove();
    }

    function updateItemTotal(row) {
        let price = parseInt(row.data("price")) || 0;
        let qty = parseInt(row.find(".qty-input").val()) || 1;
        let itemTotal = price * qty;
        row.find(".item-total").text(itemTotal.toLocaleString());
    }

    // ìˆ˜ëŸ‰ ë³€ê²½ ì´ë²¤íŠ¸
    $(document).on("change input keyup", ".qty-input", function() {
        let row = $(this).closest("tr");
        let cartItemId = row.data("id");
        let newQty = parseInt($(this).val()) || 1;

        if (newQty < 1) {
            newQty = 1;
            $(this).val(newQty);
        }

        updateItemTotal(row);
        calculateCartSummary();

        clearTimeout($(this).data('timeout'));
        $(this).data('timeout', setTimeout(function() {
            $.ajax({
                url: "/cart/" + cartItemId,
                type: "PATCH",
                contentType: "application/json",
                data: JSON.stringify({ count: newQty }),
                error: function(xhr, status, error) {
                    console.error('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            });
        }, 500));
    });

    // ==========================
    // ê°œë³„ ì‚­ì œ ê¸°ëŠ¥ (DB ì‚­ì œ ì ìš©)
    // ==========================
    $(document).on("click", ".btn-delete", function(){
        let row = $(this).closest("tr");
        let cartItemId = row.data("id");

        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            $.ajax({
                url: "/cart/" + cartItemId + "/delete", // DELETE ìš”ì²­
                type: "DELETE",
                success: function(){
                    row.fadeOut(300, function() {
                        $(this).remove();
                        calculateCartSummary();
                        if ($("#cart-body tr:not(#empty-cart-row)").length === 0) {
                            showEmptyCartMessage();
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        }
    });

    // ì „ì²´ ë¹„ìš°ê¸°
    $("#btn-clear").click(function(){
        if (confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ëª¨ë‘ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            $.ajax({
                url: "/cart/clear",
                type: "POST",
                success: function(){
                    $("#cart-body tr:not(#empty-cart-row)").fadeOut(300, function() {
                        $(this).remove();
                        calculateCartSummary();
                        showEmptyCartMessage();
                    });
                },
                error: function(xhr, status, error) {
                    console.error('ì „ì²´ ë¹„ìš°ê¸° ì‹¤íŒ¨:', error);
                    alert('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    });

    // ì£¼ë¬¸í•˜ê¸°
    $("#btn-order").click(function(){
        let totalQuantity = parseInt($("#total-quantity").text()) || 0;
        if (totalQuantity === 0) {
            alert("ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        if (confirm(`ì´ ${totalQuantity}ê°œ ìƒí’ˆì„ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            window.location.href = "cart/order";
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ê³„ì‚°
    $(document).ready(function(){
        if ($("#cart-body tr:not(#empty-cart-row)").length > 0) {
            hideEmptyCartMessage();
        }
        calculateCartSummary();
        $("#cart-body tr:not(#empty-cart-row)").each(function(){
            updateItemTotal($(this));
        });
    });
</script>

</body>
</html>
