<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .qty-input { text-align: center; width: 60px; }
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="container py-4">

<h2 class="mb-4">🛒 장바구니</h2>

<table class="table table-bordered align-middle text-center">
    <thead class="table-light">
    <tr>
        <th>상품명</th>
        <th>수량</th>
        <th>가격</th>
        <th>합계</th>
        <th>작업</th>
    </tr>
    </thead>
    <tbody id="cart-body">
    <!-- DB에서 가져온 장바구니 상품들 -->
    <tr th:each="item : ${cartItems}" th:attr="data-id=${item.cartItemId}" th:data-price="${item.price}">
        <td th:text="${item.itemNm}">상품명</td>
        <td>
            <input type="number" min="1" class="form-control form-control-sm qty-input"
                   th:value="${item.count != null ? item.count : 1}" />
        </td>
        <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')}">0</td>
        <td th:text="${#numbers.formatInteger(item.price * (item.count != null ? item.count : 1), 0, 'COMMA')}" class="item-total">0</td>
        <td>
            <!-- 수정: 개별 삭제 버튼 AJAX -->
            <button class="btn btn-danger btn-sm btn-delete">삭제</button>
        </td>
    </tr>

    <!-- 장바구니가 비어있을 때 표시 -->
    <tr th:if="${#lists.isEmpty(cartItems)}" id="empty-cart-row">
        <td colspan="5" class="text-muted py-4">
            <div class="text-center">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <p>장바구니가 비어있습니다.</p>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<!-- 요약 정보 박스 -->
<div class="summary-box mt-4">
    <div class="row">
        <div class="col-md-6">
            <h6 class="mb-2">📦 총 상품 수량: <span id="total-quantity" class="text-primary fw-bold">0</span> 개</h6>
        </div>
        <div class="col-md-6 text-end">
            <h5 class="mb-0">💰 총 결제 금액: <span id="cart-total" class="text-success fw-bold">0</span> 원</h5>
        </div>
    </div>
</div>

<div class="text-end mt-3">
    <button id="btn-clear" class="btn btn-warning me-2">전체 비우기</button>
    <button id="btn-order" class="btn btn-primary">주문하기</button>
</div>

<script>
    // 전체 장바구니 총액과 총 수량 계산 함수
    function calculateCartSummary() {
        let totalAmount = 0;
        let totalQuantity = 0;

        $("#cart-body tr:not(#empty-cart-row)").each(function(){
            let price = parseInt($(this).data("price")) || 0;
            let qty = parseInt($(this).find(".qty-input").val()) || 0;

            totalAmount += price * qty;
            totalQuantity += qty;
        });

        $("#cart-total").text(totalAmount.toLocaleString());
        $("#total-quantity").text(totalQuantity);

        if ($("#cart-body tr:not(#empty-cart-row)").length === 0) {
            $("#cart-total").text("0");
            $("#total-quantity").text("0");
            showEmptyCartMessage();
        }
    }

    function showEmptyCartMessage() {
        if ($("#empty-cart-row").length === 0) {
            $("#cart-body").append(`
                <tr id="empty-cart-row">
                    <td colspan="5" class="text-muted py-4">
                        <div class="text-center">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>장바구니가 비어있습니다.</p>
                        </div>
                    </td>
                </tr>
            `);
        }
    }

    function hideEmptyCartMessage() {
        $("#empty-cart-row").remove();
    }

    function updateItemTotal(row) {
        let price = parseInt(row.data("price")) || 0;
        let qty = parseInt(row.find(".qty-input").val()) || 1;
        let itemTotal = price * qty;
        row.find(".item-total").text(itemTotal.toLocaleString());
    }

    // 수량 변경 이벤트
    $(document).on("change input keyup", ".qty-input", function() {
        let row = $(this).closest("tr");
        let cartItemId = row.data("id");
        let newQty = parseInt($(this).val()) || 1;

        if (newQty < 1) {
            newQty = 1;
            $(this).val(newQty);
        }

        updateItemTotal(row);
        calculateCartSummary();

        clearTimeout($(this).data('timeout'));
        $(this).data('timeout', setTimeout(function() {
            $.ajax({
                url: "/cart/" + cartItemId,
                type: "PATCH",
                contentType: "application/json",
                data: JSON.stringify({ count: newQty }),
                error: function(xhr, status, error) {
                    console.error('수량 업데이트 실패:', error);
                }
            });
        }, 500));
    });

    // ==========================
    // 개별 삭제 기능 (DB 삭제 적용)
    // ==========================
    $(document).on("click", ".btn-delete", function(){
        let row = $(this).closest("tr");
        let cartItemId = row.data("id");

        if (confirm("정말 삭제하시겠습니까?")) {
            $.ajax({
                url: "/cart/" + cartItemId + "/delete", // DELETE 요청
                type: "DELETE",
                success: function(){
                    row.fadeOut(300, function() {
                        $(this).remove();
                        calculateCartSummary();
                        if ($("#cart-body tr:not(#empty-cart-row)").length === 0) {
                            showEmptyCartMessage();
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('삭제 실패:', error);
                    alert('삭제에 실패했습니다. 다시 시도해주세요.');
                }
            });
        }
    });

    // 전체 비우기
    $("#btn-clear").click(function(){
        if (confirm("장바구니를 모두 비우시겠습니까?")) {
            $.ajax({
                url: "/cart/clear",
                type: "POST",
                success: function(){
                    $("#cart-body tr:not(#empty-cart-row)").fadeOut(300, function() {
                        $(this).remove();
                        calculateCartSummary();
                        showEmptyCartMessage();
                    });
                },
                error: function(xhr, status, error) {
                    console.error('전체 비우기 실패:', error);
                    alert('장바구니 비우기에 실패했습니다.');
                }
            });
        }
    });

    // 주문하기
    $("#btn-order").click(function(){
        let totalQuantity = parseInt($("#total-quantity").text()) || 0;
        if (totalQuantity === 0) {
            alert("장바구니에 상품이 없습니다.");
            return;
        }
        if (confirm(`총 ${totalQuantity}개 상품을 주문하시겠습니까?`)) {
            window.location.href = "cart/order";
        }
    });

    // 페이지 로드 시 초기 계산
    $(document).ready(function(){
        if ($("#cart-body tr:not(#empty-cart-row)").length > 0) {
            hideEmptyCartMessage();
        }
        calculateCartSummary();
        $("#cart-body tr:not(#empty-cart-row)").each(function(){
            updateItemTotal($(this));
        });
    });
</script>

</body>
</html>
